/**
 * @name     wp-player
 * @desc     初始化播放器。
 * @depend   jQuery, SoundManager2
 * @author   M.J
 * @date     2014-12-21
 * @update   2015-01-08
 * @URL      http://webjyh.com
 * @Github   https://github.com/webjyh/WP-Player
 * @reutn    {jQuery}
 * @version  2.3.0
 * 
 */
~function(b,a){var c=function(e,d){a.setup({url:d.swf,debugMode:false});this.index=0;this.url=d.url;this.nonce=d.nonce;this.IE6=!-[1]&&!window.XMLHttpRequest;this.single=d.single;this.lyric=null;this.offset={};this.mark=null;this.lyricH=300;this.line=27;this.getDOM(b(e)).getAttr().init()};c.prototype={init:function(){var d=this.attr,e=this.DOM;e.time.text("00:00");e.title.text("Loading...");e.author.text("Loading...");if(!d.xiami){this.localAction()}else{(d.source=="xiami")?this.xiamiAction():this.neteaseAction()}},neteaseAction:function(){var d=this.attr.type,f=this.attr.xiami,e=this;b.ajax({url:this.url,type:"get",headers:{nonce:this.nonce},data:{action:"wpplayer",type:d,id:f}}).done(function(g){if(g.status&&g.data.trackList){e.data=g.data.trackList;e.createList().createSound().addEvent()}})},xiamiAction:function(){var e=this.getXiamiType(this.attr.type),f=this.attr.xiami,g=this,d="http://www.xiami.com/song/playlist/id/"+f+"/type/"+e+"/cat/json?callback=?";b.getJSON(d,function(j){if(j.status&&j.data.trackList){for(var h=0,k=j.data.trackList.length;h<k;h++){j.data.trackList[h].location=g.getXiamiLocation(j.data.trackList[h].location)}g.data=j.data.trackList;g.createList().createSound().addEvent()}else{g.getSinaApi()}}).fail(function(){g.getSinaApi()})},getSinaApi:function(){var d=typeof this.attr.type=="undefined"?"song":this.attr.type,e=this.attr.xiami,f=this;b.getJSON("http://wpplayer.sinaapp.com/?callback=?",{act:d,id:e},function(g){if(g.code>0&&g.data.length){f.data=g.data;f.createList().createSound().addEvent()}})},localAction:function(){if(typeof this.attr.address==="undefined"){return false}var d={title:this.attr.title,artist:this.attr.author,location:this.attr.address,pic:this.attr.thumb};this.data=[d];this.createList().createSound().addEvent()},createList:function(){var f=0,e="",g=this.DOM,j=this.data,d=j.length;for(;f<d;f++){var h=f%2?"odd":"";e+=c.template.replace("{i}",f).replace("{class}",h).replace("{author}",j[f].artist).replace("{serial}",f+1).replace("{title}",j[f].title)}b(e).appendTo(g.list.children("ul")).first().addClass("current");return this},createSound:function(h){var i=this,d=(typeof h==="undefined")?0:h,g=this.data[d],e=this.DOM,f=(this.single=="true"&&this.attr.autoplay=="1")?true:false;e.title.text(g.title);e.author.text(g.artist);e.thumb.find("img").attr("src",g.pic);a.onready(function(){if(typeof i.sound==="object"){i.sound.destruct()}i.timeReady=false;i.sound=a.createSound({url:g.location,onload:function(){i.timeReady=true},onplay:function(){i.setPlay()},onresume:function(){i.setPlay()},onpause:function(){i.setStop()},onfinish:function(){i.nextSound()},whileplaying:function(){var m,o,k,n,j=(this.position/this.duration)*100,l=j>100?"100%":j.toFixed(5)+"%";if(i.timeReady){n="-";m=Math.floor((this.duration-this.position)/1000);o=i.formatNumber(Math.floor(m/60));k=i.formatNumber(Math.floor(m%60))}else{n="";o="00";k="00"}e.playbar.width(l);e.time.text(n+o+":"+k);i.attr.lyric&&i.setLyric(this.position)},whileloading:function(){var j=this.bytesTotal?(this.bytesLoaded/this.bytesTotal)*100:100;e.seekbar.width(j+"%")}});i.soundEvent();i.attr.lyric&&i.getLyric();if(typeof h!=="undefined"||f){i.sound.play()}});return this},createLyric:function(w){this.emptyLyric();var k=0,e=[],o=w.split("\n"),n=o.length,u=this.DOM,f=/\[(\d+:\d+.?\d+)\]/g,d=/[^\[(\d+):(\d+.?\d+)\]\s*].+/g,m="";for(;k<n;k++){var l=b.trim(o[k]).match(f);if(b.isArray(l)){var p=b.trim(o[k]).match(d);for(var h=0;h<l.length;h++){var s=l[h].replace("[","").replace("]","").split(":"),g=(s[0]*60)+Math.floor(s[1]);e.push({time:g,lyric:b.isArray(p)?p[0]:"&nbsp;"})}}}if(!e.length){this.noLyric();return false}k=0;n=e.length;for(;k<n;k++){for(var h=k;h<n;h++){if(e[k].time>e[h].time){var r=e[k];e[k]=e[h];e[h]=r}}}this.lyric={};for(k=0;k<n;k++){m+="<li>"+e[k].lyric+"</li>";this.lyric[e[k].time]=k}u.lyricList=b(m).appendTo(u.lyrics.children("ul"));var o=u.lyrics.children("ul").height(),v=Math.floor(this.lyricH/2),q=o-v;this.offset={min:Math.floor(v/this.line),max:Math.floor(q/this.line)}},getLyric:function(){this.noLyric(this.attr.xiami?"\u6b63\u5728\u52a0\u8f7d\u6b4c\u8bcd...":"\u6682\u65e0\u6b4c\u8bcd");if(!this.attr.xiami){return false}var f=this,d=this.url+"?action=wpplayerGetLrc&type="+this.attr.source+"&id="+this.data[this.index].song_id,e=this.attr.source=="xiami"?this.data[this.index].lyric_url:"";b.ajax({url:d,type:"post",headers:{nonce:this.nonce},data:{lyric:e}}).done(function(g){(g.status&&g.lyric)?f.createLyric(g.lyric):f.noLyric()}).fail(function(){f.noLyric()})},setLyric:function(i){var f=this.DOM,h=this.offset,g=Math.floor(i/1000),e=this.lyric&&this.lyric[g],d=0;if(typeof e!=="undefined"&&f.lyricList&&this.mark!=e){if(e>=h.min){d=e-h.min}if(e>=h.max){d=h.max-h.min}f.lyricList.removeClass("current").eq(e).addClass("current");f.lyrics.children("ul").css("margin-top",-d*this.line);this.mark=e}},emptyLyric:function(){var d=this.DOM;this.lyric=null;d.lyrics.children("ul").css("margin-top",0).html("")},noLyric:function(f){var d=this.DOM,e=typeof f==="undefined"?"\u6682\u65e0\u6b4c\u8bcd":f;d.lyrics.children("ul").html("<li>"+e+"</li>")},addEvent:function(){var d=this.DOM,e=this;d.wrap.on("click","div.wp-player-list-btn",function(){var f=b(this).hasClass("wp-player-open");d.lyrics.children("ul").stop(true,true).hide();b(this)[f?"removeClass":"addClass"]("wp-player-open");d.list.stop(true,true)[f?"slideDown":"slideUp"]("fast")});d.wrap.on("click","div.wp-player-lyrics-btn",function(){d.listbtn.addClass("wp-player-open");d.list.hide();d.lyrics.children("ul").stop(true,true).fadeIn()});d.list.on("click","li",function(){var g=parseInt(b(this).attr("data-index"),10),f=b(this).hasClass("current")&&e.sound.playState>0;(g<0||g>e.data.length-1)?e.index=0:e.index=g;if(f&&!e.sound.paused){e.sound.pause()}else{if(f&&e.sound.paused){e.sound.resume()}else{e.reset().setList().createSound(e.index)}}});return this},soundEvent:function(){var d=this.DOM,e=this;d.seekbar.off().on("click",function(f){e.seekbar(f)});d.play.off().on("click",function(){e.play()});d.stop.off().on("click",function(){e.stop()});if(this.data.length>2){d.previous.off().on("click",function(){e.prevSound()});d.next.off().on("click",function(){e.nextSound()})}return this},seekbar:function(g){var f=this.DOM,e=g.offsetX?g.offsetX:(g.clientX-f.progress.offset().left).toFixed(0);var d=(e/f.progress.width())*this.sound.duration;if(d<0){d=0}if(d>this.sound.duration){d=this.sound.duration}this.sound.setPosition(d);f.lyricList&&f.lyricList.removeClass("current")},play:function(){this.sound[this.sound.playState<1?"play":"resume"]()},stop:function(){this.sound.pause()},prevSound:function(){var d=0;if(--this.index<d){this.index=this.data.length-1}this.reset().setList().createSound(this.index)},nextSound:function(){var d=this.data.length-1;if(++this.index>d){this.index=0}this.reset().setList().createSound(this.index)},setPlay:function(){var d=this.DOM;d.playing.stop(true,true)[this.IE6?"show":"fadeIn"]();d.play.hide();d.stop.show();return this},setStop:function(){var d=this.DOM;d.playing.stop(true,true)[this.IE6?"hide":"fadeOut"]();d.play.show();d.stop.hide();return this},reset:function(){var d=this.DOM;this.setStop();d.seekbar.width(0);d.playbar.width(0);return this},setList:function(){var d=this.DOM;d.list.find("li").removeClass("current").eq(this.index).addClass("current");return this},getDOM:function(d){var h=d[0].getElementsByTagName("*"),g={};g.wrap=d;for(var f=0;f<h.length;f++){if(h[f].className.indexOf("wp-player")>-1){var e=h[f].className.replace("wp-player","").replace(/-/g,"");g[e]=b(h[f])}}this.DOM=g;return this},formatNumber:function(d){return d.toString().length<2?"0"+d:d},getAttr:function(){var f=this.DOM,e=f.wrap.attr("data-lyric"),d=typeof e==="undefined"?false:(e=="open"?true:false);this.attr={source:f.wrap.attr("data-source"),type:f.wrap.attr("data-type"),xiami:f.wrap.attr("data-xiami"),title:f.wrap.attr("data-title"),author:f.wrap.attr("data-author"),address:f.wrap.attr("data-address"),thumb:f.wrap.attr("data-thumb"),autoplay:f.wrap.attr("data-autoplay"),lyric:d};return this},getXiamiType:function(e){var d;switch(e){case"song":d=0;break;case"album":d=1;break;case"artist":d=2;break;case"collect":d=3;break;default:d=0}return d},getXiamiLocation:function(o){try{var g=parseInt(o.charAt(0)),f=o.substring(1),d=Math.floor(f.length/g),u=f.length%g,t=[],s=0,r="",q="";for(;s<u;++s){t[s]=f.substr((d+1)*s,(d+1))}for(;s<g;++s){t[s]=f.substr(d*(s-u)+(d+1)*u,d)}for(var l=0,m=t[0].length;l<m;++l){for(var k=0,h=t.length;k<h;++k){r+=t[k].charAt(l)}}r=decodeURIComponent(r);for(var l=0,p=r.length;l<p;++l){q+=r.charAt(l)==="^"?"0":r.charAt(l)}return q}catch(n){return false}}};c.template='<li data-index="{i}" class="{class}"><a href="javascript:void(0);"><span class="wp-player-list-author">{author}</span><span class="wp-player-list-order">{serial}</span><span class="wp-player-list-title">{title}</span></a></li>';b.fn.WPPlayer=function(d){return this.each(function(){new c(this,d)})};return b}(jQuery,soundManager);jQuery('[data-wp-player="wp-player"]').WPPlayer(wp_player_params);