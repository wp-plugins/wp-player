/**
 * @name     wp-player
 * @desc     初始化播放器。
 * @depend   jQuery, SoundManager2
 * @author   M.J
 * @date     2014-12-21
 * @update   2015-01-01
 * @URL      http://webjyh.com
 * @Github   https://github.com/webjyh/WP-Player
 * @reutn    {jQuery}
 * @version  2.2.0
 * 
 */
~function(b,a){var c=function(e,d){a.setup({url:d.swf,debugMode:false});this.index=0;this.url=d.url,this.nonce=d.nonce,this.IE6=!-[1]&&!window.XMLHttpRequest;this.single=d.single;this.getDOM(b(e)).getAttr().init()};c.prototype={init:function(){var d=this.attr,e=this.DOM;e.time.text("00:00");e.title.text("Loading...");e.author.text("Loading...");if(!d.xiami){this.localAction()}else{(d.source=="xiami")?this.xiamiAction():this.neteaseAction()}},neteaseAction:function(){var d=this.attr.type,f=this.attr.xiami,e=this;b.ajax({url:this.url,type:"get",headers:{nonce:this.nonce},data:{action:"wpplayer",type:d,id:f}}).done(function(g){if(g.status&&g.data.trackList){e.data=g.data.trackList;e.createList().createSound().addEvent()}})},xiamiAction:function(){var e=this.getXiamiType(this.attr.type),f=this.attr.xiami,g=this,d="http://www.xiami.com/song/playlist/id/"+f+"/type/"+e+"/cat/json?callback=?";b.getJSON(d,function(j){if(j.status&&j.data.trackList){for(var h=0,k=j.data.trackList.length;h<k;h++){j.data.trackList[h].location=g.getXiamiLocation(j.data.trackList[h].location)}g.data=j.data.trackList;g.createList().createSound().addEvent()}else{g.getSinaApi()}}).fail(function(){g.getSinaApi()})},getSinaApi:function(){var d=typeof this.attr.type=="undefined"?"song":this.attr.type,e=this.attr.xiami,f=this;b.getJSON("http://wpplayer.sinaapp.com/?callback=?",{act:d,id:e},function(g){if(g.code>0&&g.data.length){f.data=g.data;f.createList().createSound().addEvent()}})},localAction:function(){if(typeof this.attr.address==="undefined"){return false}var d={title:this.attr.title,artist:this.attr.author,location:this.attr.address,pic:this.attr.thumb};this.data=[d];this.createList().createSound().addEvent()},createList:function(){var f=0,e="",g=this.DOM,j=this.data,d=j.length;for(;f<d;f++){var h=f%2?"odd":"";e+=c.template.replace("{i}",f).replace("{class}",h).replace("{author}",j[f].artist).replace("{serial}",f+1).replace("{title}",j[f].title)}b(e).appendTo(g.list.children("ul")).first().addClass("current");return this},createSound:function(h){var i=this,d=(typeof h==="undefined")?0:h,g=this.data[d],e=this.DOM,f=(this.single=="true"&&this.attr.autoplay=="1")?true:false;e.title.text(g.title);e.author.text(g.artist);e.thumb.find("img").attr("src",g.pic);a.onready(function(){if(typeof i.sound==="object"){i.sound.destruct()}i.timeReady=false;i.sound=a.createSound({url:g.location,onload:function(){i.timeReady=true},onplay:function(){i.setPlay()},onresume:function(){i.setPlay()},onpause:function(){i.setStop()},onfinish:function(){i.nextSound()},whileplaying:function(){var m,o,k,n,j=(this.position/this.duration)*100,l=j>100?"100%":j.toFixed(5)+"%";if(i.timeReady){n="-";m=Math.floor((this.duration-this.position)/1000);o=i.formatNumber(Math.floor(m/60));k=i.formatNumber(Math.floor(m%60))}else{n="";o="00";k="00"}e.playbar.width(l);e.time.text(n+o+":"+k)},whileloading:function(){var j=this.bytesTotal?(this.bytesLoaded/this.bytesTotal)*100:100;e.seekbar.width(j+"%")}});i.soundEvent();if(typeof h!=="undefined"||f){i.sound.play()}});return this},addEvent:function(){var d=this.DOM,e=this;d.wrap.on("click","div.wp-player-list-btn",function(){var f=b(this).hasClass("wp-player-open");b(this)[f?"removeClass":"addClass"]("wp-player-open");d.list.stop(true,true)[f?"slideDown":"slideUp"]("fast")});d.list.on("click","li",function(){var g=parseInt(b(this).attr("data-index"),10),f=b(this).hasClass("current")&&e.sound.playState>0;(g<0||g>e.data.length-1)?e.index=0:e.index=g;if(f&&!e.sound.paused){e.sound.pause()}else{if(f&&e.sound.paused){e.sound.resume()}else{e.reset().setList().createSound(e.index)}}});return this},soundEvent:function(){var d=this.DOM,e=this;d.seekbar.off().on("click",function(f){e.seekbar(f)});d.play.off().on("click",function(){e.play()});d.stop.off().on("click",function(){e.stop()});if(this.data.length>2){d.previous.off().on("click",function(){e.prevSound()});d.next.off().on("click",function(){e.nextSound()})}},seekbar:function(g){var f=this.DOM,e=g.offsetX?g.offsetX:(g.clientX-f.progress.offset().left).toFixed(0);var d=(e/f.progress.width())*this.sound.duration;if(d<0){d=0}if(d>this.sound.duration){d=this.sound.duration}this.sound.setPosition(d)},play:function(){this.sound[this.sound.playState<1?"play":"resume"]()},stop:function(){this.sound.pause()},prevSound:function(){var d=0;if(--this.index<d){this.index=this.data.length-1}this.reset().setList().createSound(this.index)},nextSound:function(){var d=this.data.length-1;if(++this.index>d){this.index=0}this.reset().setList().createSound(this.index)},setPlay:function(){var d=this.DOM;d.playing.stop(true,true)[this.IE6?"show":"fadeIn"]();d.play.hide();d.stop.show();return this},setStop:function(){var d=this.DOM;d.playing.stop(true,true)[this.IE6?"hide":"fadeOut"]();d.play.show();d.stop.hide();return this},reset:function(){var d=this.DOM;this.setStop();d.seekbar.width(0);d.playbar.width(0);return this},setList:function(){var d=this.DOM;d.list.find("li").removeClass("current").eq(this.index).addClass("current");return this},getDOM:function(d){var h=d[0].getElementsByTagName("*"),g={};g.wrap=d;for(var f=0;f<h.length;f++){if(h[f].className.indexOf("wp-player")>-1){var e=h[f].className.replace("wp-player","").replace(/-/g,"");g[e]=b(h[f])}}this.DOM=g;return this},formatNumber:function(d){return d.toString().length<2?"0"+d:d},getAttr:function(){var d=this.DOM;this.attr={source:d.wrap.attr("data-source"),type:d.wrap.attr("data-type"),xiami:d.wrap.attr("data-xiami"),title:d.wrap.attr("data-title"),author:d.wrap.attr("data-author"),address:d.wrap.attr("data-address"),thumb:d.wrap.attr("data-thumb"),autoplay:d.wrap.attr("data-autoplay")};return this},getXiamiType:function(e){var d;switch(e){case"song":d=0;break;case"album":d=1;break;case"artist":d=2;break;case"collect":d=3;break;default:d=0}return d},getXiamiLocation:function(o){try{var g=parseInt(o.charAt(0)),f=o.substring(1),d=Math.floor(f.length/g),u=f.length%g,t=[],s=0,r="",q="";for(;s<u;++s){t[s]=f.substr((d+1)*s,(d+1))}for(;s<g;++s){t[s]=f.substr(d*(s-u)+(d+1)*u,d)}for(var l=0,m=t[0].length;l<m;++l){for(var k=0,h=t.length;k<h;++k){r+=t[k].charAt(l)}}r=decodeURIComponent(r);for(var l=0,p=r.length;l<p;++l){q+=r.charAt(l)==="^"?"0":r.charAt(l)}return q}catch(n){return false}}};c.template='<li data-index="{i}" class="{class}"><a href="javascript:void(0);"><span class="wp-player-list-author">{author}</span><span class="wp-player-list-order">{serial}</span><span class="wp-player-list-title">{title}</span></a></li>';b.fn.WPPlayer=function(d){return this.each(function(){new c(this,d)})};return b}(jQuery,soundManager);jQuery('[data-wp-player="wp-player"]').WPPlayer(wp_player_params);